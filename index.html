<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telugu Swaggers â€” Reports</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f6f8fa;
      --card: #ffffff;
      --muted: #677289;
      --accent: #f5c335; /* yellow accent */
      --accent-strong: #e0ac1a;
      --text: #102027;
      --danger: #e24b3b;
      --radius: 12px;
      --gap: 16px;
      --maxw: 1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:var(--maxw);margin:20px auto;padding:18px;display:flex;flex-direction:column;gap:18px}

    /* header */
    header.appbar{display:flex;justify-content:space-between;align-items:center;background:var(--card);padding:12px 16px;border-radius:12px;box-shadow:0 6px 18px rgba(12,15,20,0.04)}
    .brand h1{margin:0;font-size:18px}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:13px}
    .auth-row{display:flex;gap:10px;align-items:center}
    .small-muted{font-size:13px;color:var(--muted)}

    /* layout */
    .layout{display:grid;grid-template-columns:1fr 280px;gap:var(--gap)}
    @media (max-width:980px){ .layout{grid-template-columns:1fr} }

    /* card */
    .card{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 6px 20px rgba(12,15,20,0.04)}
    .card h2{margin:0 0 10px;font-size:16px}

    /* add form */
    .form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .form-grid input,.form-grid select,.form-grid textarea{padding:10px;border-radius:8px;border:1px solid #e7eaf0;background:#fff;font-size:14px}
    .form-grid textarea{grid-column:1/4;min-height:72px;resize:vertical}
    .form-actions{display:flex;gap:8px;justify-content:flex-end;align-items:center;margin-top:6px}
    .muted{color:var(--muted)}
    .hint{font-size:13px;color:var(--muted)}

    /* summary */
    .summary{display:flex;gap:12px;flex-wrap:wrap}
    .stat{flex:1;min-width:150px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fff);box-shadow:0 2px 8px rgba(12,15,20,0.03)}
    .stat .label{font-size:13px;color:var(--muted)}
    .stat .val{font-weight:700;font-size:18px;margin-top:6px}

    /* filters */
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .filters input,.filters select{padding:8px;border-radius:8px;border:1px solid #e7eaf0;background:#fff}

    /* table */
    .table-wrap{overflow:auto;margin-top:8px}
    table{width:100%;border-collapse:collapse;min-width:860px}
    th,td{padding:10px;border-bottom:1px solid #f1f4f7;text-align:left;font-size:14px;vertical-align:middle}
    th{background:#fbfdff;color:var(--muted);font-weight:600}
    .link-cell a{color:var(--text);text-decoration:none}
    .actions-inline{display:flex;gap:6px;align-items:center}

    .icon-btn{background:transparent;border:0;cursor:pointer;padding:6px;border-radius:6px}
    .icon-yellow{background:var(--accent);color:#111}
    .status-paid{color:green;font-weight:600}
    .status-pending{color:orange;font-weight:600}

    /* sidebar agencies */
    .sidebar .title{font-size:14px;margin-bottom:8px}
    .agency-item{display:flex;justify-content:space-between;padding:8px;border-radius:8px;background:#fbfbfb;border:1px solid #f1f3f5;font-size:13px;margin-bottom:8px}

    /* reminder */
    .reminder{box-shadow:inset 6px 0 0 0 rgba(224,76,52,0.08)}

    /* yellow buttons */
    .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(16,24,40,0.04);cursor:pointer;font-weight:600;background:transparent}
    .btn.accent{background:var(--accent);border-color:var(--accent-strong);color:#111}

    /* minimalistic small */
    .small{font-size:13px;color:var(--muted)}

    /* responsive */
    @media (max-width:760px){
      .form-grid{grid-template-columns:repeat(2,1fr)}
      .form-grid textarea{grid-column:1/3}
      .table-wrap{overflow-x:auto}
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="appbar card">
      <div class="brand">
        <h1>Telugu Swaggers</h1>
        <p class="small-muted">Promotions & payments dashboard</p>
      </div>

      <div class="auth-row">
        <div id="userInfo" class="small-muted">Not signed in</div>
        <button id="loginBtn" class="btn accent">Sign in</button>
        <button id="logoutBtn" class="btn" hidden>Logout</button>
      </div>
    </header>

    <div class="layout">
      <!-- LEFT: main content -->
      <div class="left-col">

        <!-- Add Report -->
        <section class="card">
          <h2>Add Report</h2>
          <form id="reportForm" class="form-grid">
            <input id="link" type="url" placeholder="Insta/X Link" required />
            <input id="agency" type="text" placeholder="Agency" list="agencyList" required />
            <input id="movie" type="text" placeholder="Movie" list="movieList" required />
            <input id="amount" type="number" placeholder="Amount (â‚¹)" value="1200" />
            <select id="status">
              <option value="Pending">Pending</option>
              <option value="Paid">Paid</option>
            </select>
            <input id="date" type="date" />
            <textarea id="notes" placeholder=""></textarea>

            <div class="form-actions" style="grid-column:1/4">
              <div class="hint" style="margin-right:auto">Date defaults to today if left blank â€¢ Notes optional</div>
              <button id="addBtn" class="btn accent" type="submit">Add</button>
              <button id="clearBtn" class="btn" type="button">Clear</button>
              <button id="exportPdf" class="btn" type="button">Export PDF</button>
            </div>
          </form>
        </section>

        <!-- Summary -->
        <section class="card">
          <h2>Summary</h2>
          <div class="summary">
            <div class="stat">
              <div class="label">Total pending amount</div>
              <div id="totalPending" class="val">â‚¹0</div>
            </div>
            <div class="stat">
              <div class="label">Total cleared amount</div>
              <div id="totalCleared" class="val">â‚¹0</div>
            </div>
            <div class="stat">
              <div class="label">Entries this month</div>
              <div id="totalThisMonth" class="val">0</div>
            </div>
            <div class="stat">
              <div class="label">Top agency</div>
              <div id="topAgency" class="val">â€”</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:180px">
              <div class="small muted"><strong>Pending â€” last 3 months</strong></div>
              <ul id="pendingByMonth" class="small" style="margin-top:8px"></ul>
            </div>

            <div style="flex:1;min-width:180px">
              <div class="small muted"><strong>Top 5 agencies (pending)</strong></div>
              <ol id="pendingByAgency" class="small" style="margin-top:8px"></ol>
            </div>

            <div style="flex:1;min-width:180px">
              <div class="small muted"><strong>Top 5 movies (pending)</strong></div>
              <ol id="pendingByMovie" class="small" style="margin-top:8px"></ol>
            </div>
          </div>
        </section>

        <!-- Reports -->
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h2 style="margin:0">Your Reports</h2>
            <div class="small-muted">Visible only to you</div>
          </div>

          <div style="margin-top:10px" class="filters">
            <input id="filterSearch" placeholder="Search link / agency / movie" style="flex:1" />
            <input id="filterAgency" placeholder="Filter agency" style="width:160px" />
            <input id="filterMovie" placeholder="Filter movie" style="width:160px" />
            <select id="filterStatus" style="width:120px">
              <option value="All">All</option>
              <option value="Pending">Pending</option>
              <option value="Paid">Paid</option>
            </select>
            <button id="applyFilters" class="btn">Apply</button>
            <button id="resetFilters" class="btn">Reset</button>
            <button id="exportCsv" class="btn">Export CSV</button>
          </div>

          <div class="table-wrap" style="margin-top:12px">
            <table id="reportsTable">
              <thead>
                <tr>
                  <th>Link</th>
                  <th>Agency</th>
                  <th>Movie</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Notes</th>
                  <th style="width:120px"></th>
                </tr>
              </thead>
              <tbody id="reportsBody">
                <tr><td colspan="8" class="muted">Sign in to view your reports</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- RIGHT: agencies sidebar -->
      <aside class="sidebar">
        <div class="card">
          <div class="title">Agencies</div>
          <div id="agencyPane" style="margin-top:10px">
            <div class="small-muted">No agencies yet</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div class="title">Quick actions</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <button id="remindersBtn" class="btn">Show reminders (30+ days)</button>
            <button id="clearLocal" class="btn">Clear suggestions</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- datalists for autosuggest -->
  <datalist id="agencyList"></datalist>
  <datalist id="movieList"></datalist>

  <!-- Firebase compat JS -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDeuC7hS30cJHXoTGx6BbmW8g_kwLGakDA",
    authDomain: "vadisi-reports.firebaseapp.com",
    projectId: "vadisi-reports",
    storageBucket: "vadisi-reports.firebasestorage.app",
    messagingSenderId: "574994089915",
    appId: "1:574994089915:web:a83456675ac8f7c4fba69e"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---------- DOM ----------
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const userInfo = document.getElementById('userInfo');

  const reportForm = document.getElementById('reportForm');
  const linkInput = document.getElementById('link');
  const agencyInput = document.getElementById('agency');
  const movieInput = document.getElementById('movie');
  const amountInput = document.getElementById('amount');
  const statusInput = document.getElementById('status');
  const dateInput = document.getElementById('date');
  const notesInput = document.getElementById('notes');
  const clearBtn = document.getElementById('clearBtn');
  const exportPdfBtn = document.getElementById('exportPdf');

  const totalPendingEl = document.getElementById('totalPending');
  const totalClearedEl = document.getElementById('totalCleared');
  const totalThisMonthEl = document.getElementById('totalThisMonth');
  const topAgencyEl = document.getElementById('topAgency');
  const pendingByMonthEl = document.getElementById('pendingByMonth');
  const pendingByAgencyEl = document.getElementById('pendingByAgency');
  const pendingByMovieEl = document.getElementById('pendingByMovie');

  const filterSearch = document.getElementById('filterSearch');
  const filterAgency = document.getElementById('filterAgency');
  const filterMovie = document.getElementById('filterMovie');
  const filterStatus = document.getElementById('filterStatus');
  const applyFiltersBtn = document.getElementById('applyFilters');
  const resetFiltersBtn = document.getElementById('resetFilters');
  const exportCsvBtn = document.getElementById('exportCsv');

  const reportsBody = document.getElementById('reportsBody');
  const agencyPane = document.getElementById('agencyPane');
  const agencyList = document.getElementById('agencyList');
  const movieList = document.getElementById('movieList');

  const remindersBtn = document.getElementById('remindersBtn');
  const clearLocalBtn = document.getElementById('clearLocal');

  // ---------- STATE ----------
  let uid = null;
  let unsub = null;
  let cached = [];
  let localAgencies = JSON.parse(localStorage.getItem('v_agencies')||'[]');
  let localMovies = JSON.parse(localStorage.getItem('v_movies')||'[]');

  // default date -> today
  dateInput.value = new Date().toISOString().slice(0,10);

  // ---------- AUTH ----------
  loginBtn.addEventListener('click', async ()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    try{
      await auth.signInWithPopup(provider);
    }catch(e){
      alert('Sign-in failed: '+ (e.message || e));
      console.error(e);
    }
  });
  logoutBtn.addEventListener('click', ()=> auth.signOut());

  auth.onAuthStateChanged(user=>{
    if(user){
      uid = user.uid;
      userInfo.textContent = user.email;
      loginBtn.hidden = true;
      logoutBtn.hidden = false;
      startRealtime();
      loadLocalDatalists();
    }else{
      uid = null;
      userInfo.textContent = 'Not signed in';
      loginBtn.hidden = false;
      logoutBtn.hidden = true;
      stopRealtime();
      reportsBody.innerHTML = '<tr><td colspan="8" class="muted">Sign in to view your reports</td></tr>';
      clearSummary();
    }
  });

  // ---------- REALTIME ----------
  function startRealtime(){
    if(!uid) return;
    if(unsub) unsub();
    const col = db.collection('users').doc(uid).collection('reports');
    const q = col.orderBy('date','desc');
    unsub = q.onSnapshot(snap=>{
      const arr=[];
      snap.forEach(d=> arr.push({ id: d.id, ...d.data() }));
      cached = arr;
      renderTable();
      summarize();
      saveLocalFromCached();
    }, err=>{
      console.error('Realtime error', err);
    });
  }
  function stopRealtime(){
    if(unsub){ unsub(); unsub = null; cached = []; }
  }

  // ---------- ADD REPORT ----------
  reportForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!uid) return alert('Sign in first');
    const doc = {
      link: linkInput.value.trim(),
      agency: agencyInput.value.trim(),
      movie: movieInput.value.trim(),
      amount: Number(amountInput.value) || 1200,
      status: statusInput.value || 'Pending',
      date: dateInput.value ? new Date(dateInput.value + 'T00:00:00').toISOString() : new Date().toISOString(),
      notes: notesInput.value.trim() || '',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    try{
      await db.collection('users').doc(uid).collection('reports').add(doc);
      addToLocalLists(doc.agency, doc.movie);
      reportForm.reset();
      amountInput.value = 1200;
      dateInput.value = new Date().toISOString().slice(0,10);
    }catch(e){ console.error(e); alert('Add failed: '+ e.message); }
  });

  clearBtn.addEventListener('click', ()=>{ reportForm.reset(); amountInput.value = 1200; dateInput.value = new Date().toISOString().slice(0,10); });

  // ---------- RENDER TABLE ----------
  function renderTable(){
    const visible = applyFilters(cached);
    if(!visible.length){ reportsBody.innerHTML = '<tr><td colspan="8" class="muted">No records</td></tr>'; return; }
    reportsBody.innerHTML = visible.map(r=>{
      const displayDate = formatDDMON(r.date);
      const isPending = (String(r.status||'').toLowerCase() !== 'paid');
      const ageDays = Math.floor((Date.now() - new Date(r.date).getTime())/(1000*60*60*24));
      const reminder = (isPending && ageDays>30) ? 'reminder' : '';
      return `<tr data-id="${r.id}" class="${reminder}">
        <td class="link-cell"><a href="${escapeHtml(r.link||'')}" target="_blank">${escapeHtml(r.link||'')}</a></td>
        <td class="agency-cell" data-field="agency">${escapeHtml(r.agency||'')}</td>
        <td class="movie-cell" data-field="movie">${escapeHtml(r.movie||'')}</td>
        <td class="amount-cell" data-field="amount">â‚¹${Number(r.amount)||0}</td>
        <td class="status-cell" data-field="status">${escapeHtml(r.status||'')}</td>
        <td class="date-cell" data-field="date">${displayDate}</td>
        <td class="notes-cell" data-field="notes">${escapeHtml(r.notes||'')}</td>
        <td class="actions-inline">
          <button class="icon-btn icon-yellow edit" title="Edit">âœŽ</button>
          <button class="icon-btn dup" title="Duplicate">âŽ˜</button>
          <button class="icon-btn del" title="Delete" style="color:var(--danger)">ðŸ—‘</button>
        </td>
      </tr>`;
    }).join('');
    attachRowEvents();
  }

  function attachRowEvents(){
    reportsBody.querySelectorAll('tr[data-id]').forEach(tr=>{
      const id = tr.dataset.id;
      tr.querySelector('.edit').onclick = ()=> enableInlineEdit(tr, id);
      tr.querySelector('.dup').onclick = async ()=>{
        const r = cached.find(x=> x.id===id);
        if(!r) return;
        const copy = {...r, date: new Date().toISOString(), createdAt: firebase.firestore.FieldValue.serverTimestamp()};
        delete copy.id;
        try{ await db.collection('users').doc(uid).collection('reports').add(copy); }catch(e){ console.error(e); }
      };
      tr.querySelector('.del').onclick = async ()=>{
        if(!confirm('Delete this report?')) return;
        try{ await db.collection('users').doc(uid).collection('reports').doc(id).delete(); }catch(e){ console.error(e); }
      };
    });
  }

  // inline edit saves on blur
  function enableInlineEdit(tr, id){
    const fields = tr.querySelectorAll('td[data-field]');
    fields.forEach(cell=>{
      const field = cell.dataset.field;
      cell.contentEditable = 'true';
      cell.focus();
      cell.addEventListener('blur', async function onBlur(){
        cell.removeEventListener('blur', onBlur);
        cell.contentEditable = 'false';
        let newVal = cell.innerText.trim();
        if(field === 'amount'){ newVal = Number(newVal.replace(/[^\d.-]/g,'')) || 0; }
        if(field === 'date'){
          // accept DD-MON-YYYY or yyyy-mm-dd
          const parsed = Date.parse(newVal);
          if(!isNaN(parsed)) newVal = new Date(parsed).toISOString();
          else {
            // try DD-MON-YYYY -> convert
            const parts = newVal.split('-');
            if(parts.length===3){
              const dd = parts[0], mon = parts[1], yy = parts[2];
              const maybe = Date.parse(mon + ' ' + dd + ' ' + yy);
              if(!isNaN(maybe)) newVal = new Date(maybe).toISOString();
            }
          }
        }
        const update = {};
        update[field] = newVal;
        try{
          await db.collection('users').doc(uid).collection('reports').doc(id).update(update);
        }catch(e){ console.error('Update failed', e); }
      });
    });
  }

  // ---------- FILTERS ----------
  function applyFilters(list){
    let out = Array.from(list);
    const s = (filterSearch.value||'').toLowerCase().trim();
    const a = (filterAgency.value||'').toLowerCase().trim();
    const m = (filterMovie.value||'').toLowerCase().trim();
    const st = filterStatus.value;

    if(s) out = out.filter(r => (r.link||'').toLowerCase().includes(s) || (r.agency||'').toLowerCase().includes(s) || (r.movie||'').toLowerCase().includes(s));
    if(a) out = out.filter(r => (r.agency||'').toLowerCase().includes(a));
    if(m) out = out.filter(r => (r.movie||'').toLowerCase().includes(m));
    if(st && st !== 'All') out = out.filter(r => (r.status||'') === st);

    // sorting default: date desc
    const sortKey = document.getElementById('sortBy') ? document.getElementById('sortBy').value : 'date_desc';
    out.sort((x,y)=>{
      switch(sortKey){
        case 'date_asc': return (x.date||'').localeCompare(y.date||'');
        case 'date_desc': return (y.date||'').localeCompare(x.date||'');
        case 'amount_asc': return (Number(x.amount)||0) - (Number(y.amount)||0);
        case 'amount_desc': return (Number(y.amount)||0) - (Number(x.amount)||0);
        default: return 0;
      }
    });

    return out;
  }

  applyFiltersBtn.addEventListener('click', ()=> renderTable());
  resetFiltersBtn.addEventListener('click', ()=>{
    filterSearch.value=''; filterAgency.value=''; filterMovie.value=''; filterStatus.value='All';
    renderTable();
  });

  // ---------- SUMMARY ----------
  function summarize(){
    const list = cached || [];
    const totalPending = list.filter(r=> (r.status||'').toLowerCase()!=='paid').reduce((s,r)=> s + (Number(r.amount)||0), 0);
    const totalCleared = list.filter(r=> (r.status||'').toLowerCase()==='paid').reduce((s,r)=> s + (Number(r.amount)||0), 0);
    totalPendingEl.textContent = 'â‚¹' + totalPending;
    totalClearedEl.textContent = 'â‚¹' + totalCleared;

    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
    const thisMonthCount = list.filter(r=> (r.date||'') >= monthStart).length;
    totalThisMonthEl.textContent = thisMonthCount;

    // pending by last 3 months
    const months = [2,1,0].map(i => {
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      return { label: d.toLocaleString('en-US',{month:'short', year:'numeric'}), year: d.getFullYear(), month: d.getMonth()+1 };
    });
    pendingByMonthEl.innerHTML = months.map(m=>{
      const sum = list.filter(r=>{
        const dt = new Date(r.date||'');
        return dt.getFullYear() === m.year && (dt.getMonth()+1) === m.month && ((r.status||'').toLowerCase()!=='paid');
      }).reduce((s,r)=> s + (Number(r.amount)||0), 0);
      return `<li>${m.label}: â‚¹${sum}</li>`;
    }).join('');

    // top 5 agencies by pending amount
    const ag = {};
    list.filter(r=> (r.status||'').toLowerCase()!=='paid').forEach(r=> ag[r.agency] = (ag[r.agency]||0) + (Number(r.amount)||0));
    pendingByAgencyEl.innerHTML = Object.entries(ag).sort((a,b)=> b[1]-a[1]).slice(0,5).map(x=> `<li>${escapeHtml(x[0]||'â€”')} â€” â‚¹${x[1]}</li>`).join('') || '<li>â€”</li>';

    // top 5 movies
    const mv = {};
    list.filter(r=> (r.status||'').toLowerCase()!=='paid').forEach(r=> mv[r.movie] = (mv[r.movie]||0) + (Number(r.amount)||0));
    pendingByMovieEl.innerHTML = Object.entries(mv).sort((a,b)=> b[1]-a[1]).slice(0,5).map(x=> `<li>${escapeHtml(x[0]||'â€”')} â€” â‚¹${x[1]}</li>`).join('') || '<li>â€”</li>';

    // top agency overall
    const counts = {};
    list.forEach(r=> counts[r.agency] = (counts[r.agency]||0) + (Number(r.amount)||0));
    const top = Object.keys(counts).sort((a,b)=> (counts[b]||0) - (counts[a]||0))[0] || 'â€”';
    topAgencyEl.textContent = top;

    updateAgencyPane(list);
  }

  function updateAgencyPane(list){
    const m = {};
    list.forEach(r=> { if(r.agency) m[r.agency] = (m[r.agency]||0) + (Number(r.amount)||0); });
    agencyPane.innerHTML = Object.entries(m).sort((a,b)=> b[1]-a[1]).map(x=> `<div class="agency-item"><div>${escapeHtml(x[0])}</div><div class="small-muted">â‚¹${x[1]}</div></div>`).join('') || '<div class="small-muted">No agencies</div>';
  }

  function clearSummary(){
    totalPendingEl.textContent = 'â‚¹0'; totalClearedEl.textContent = 'â‚¹0'; totalThisMonthEl.textContent = '0'; topAgencyEl.textContent = 'â€”';
    pendingByMonthEl.innerHTML = ''; pendingByAgencyEl.innerHTML = ''; pendingByMovieEl.innerHTML = ''; agencyPane.innerHTML = '<div class="small-muted">No agencies yet</div>';
  }

  // ---------- EXPORT CSV ----------
  exportCsvBtn.addEventListener('click', ()=>{
    const rows = applyFilters(cached).map(r=> [r.link||'', r.agency||'', r.movie||'', r.amount||0, r.status||'', formatDDMON(r.date||''), r.notes||'']);
    if(!rows.length) return alert('No rows to export');
    const csv = [['Link','Agency','Movie','Amount','Status','Date','Notes'], ...rows].map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `vadisi_reports_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  });

  // ---------- EXPORT PDF (print) ----------
  exportPdfBtn.addEventListener('click', ()=>{
    const list = applyFilters(cached);
    if(!list.length) return alert('No rows');
    const html = `<html><head><title>Telugu Swaggers Export</title><style>body{font-family:Arial;padding:12px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:6px;text-align:left}th{background:#f5f5f5}</style></head><body><h3>Telugu Swaggers â€” Export</h3><table><thead><tr><th>Link</th><th>Agency</th><th>Movie</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead><tbody>${list.map(r=> `<tr><td>${escapeHtml(r.link||'')}</td><td>${escapeHtml(r.agency||'')}</td><td>${escapeHtml(r.movie||'')}</td><td>â‚¹${r.amount||0}</td><td>${escapeHtml(r.status||'')}</td><td>${formatDDMON(r.date)}</td></tr>`).join('')}</tbody></table></body></html>`;
    const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=> w.print(), 600);
  });

  // ---------- local autosuggest ----------
  function addToLocalLists(ag, mv){
    if(ag && !localAgencies.includes(ag)){ localAgencies.unshift(ag); if(localAgencies.length>80) localAgencies.pop(); localStorage.setItem('v_agencies', JSON.stringify(localAgencies)); }
    if(mv && !localMovies.includes(mv)){ localMovies.unshift(mv); if(localMovies.length>80) localMovies.pop(); localStorage.setItem('v_movies', JSON.stringify(localMovies)); }
    loadLocalDatalists();
  }
  function loadLocalDatalists(){
    localAgencies = JSON.parse(localStorage.getItem('v_agencies')||'[]');
    localMovies = JSON.parse(localStorage.getItem('v_movies')||'[]');
    agencyList.innerHTML = localAgencies.map(a=> `<option value="${escapeHtml(a)}">`).join('');
    movieList.innerHTML = localMovies.map(m=> `<option value="${escapeHtml(m)}">`).join('');
    // populate sidebar with top agencies
    agencyPane.innerHTML = localAgencies.length ? localAgencies.slice(0,40).map(a=> `<div class="agency-item"><div>${escapeHtml(a)}</div><div class="small-muted">â€”</div></div>`).join('') : '<div class="small-muted">No agencies yet</div>';
  }
  clearLocalBtn.addEventListener('click', ()=>{ localStorage.removeItem('v_agencies'); localStorage.removeItem('v_movies'); localAgencies=[]; localMovies=[]; loadLocalDatalists(); alert('Cleared local suggestions'); });

  // ---------- reminders ----------
  remindersBtn.addEventListener('click', ()=>{
    const reminders = cached.filter(r=> (String(r.status||'').toLowerCase()!=='paid') && ((Date.now() - new Date(r.date).getTime())/(1000*60*60*24) > 30));
    if(!reminders.length) return alert('No reminders');
    // find first matching row and scroll to it
    const first = reminders[0];
    const row = Array.from(document.querySelectorAll('#reportsBody tr')).find(tr=> tr.dataset.id === first.id);
    if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
    alert(reminders.length + ' pending reminders found (>=30 days).');
  });

  // ---------- helpers ----------
  function formatDDMON(iso){
    if(!iso) return '';
    const d = new Date(iso);
    if(isNaN(d)) return iso;
    const dd = String(d.getDate()).padStart(2,'0');
    const mon = d.toLocaleString('en-US',{month:'short'}).toUpperCase();
    const yyyy = d.getFullYear();
    return `${DD}-${MON}-${YYYY}`;
  }
  function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

  function saveLocalFromCached(){ cached.forEach(r=> { if(r.agency) addToLocalLists(r.agency, r.movie); }); }

  // ---------- apply realtime changes on initial load if signed-in ----------
  // fetch once if realtime didn't populate
  setTimeout(()=>{ if(uid && cached.length===0){ /* no-op - realtime should fill */ } }, 800);

  // ---------- initial local datalists load ----------
  loadLocalDatalists();

  // ---------- expose debug utilities ----------
  window.vadisi = { cached, renderTable, summarize, startRealtime, stopRealtime };

  </script>
</body>
</html>
